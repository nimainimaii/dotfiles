#!/bin/sh

BGCOL="$(xrdb -query | grep "\*.background:")"
BGCOL="${BGCOL##*:	}"

WALLPAPER_FILE="$HOME/.config/wallpaper"
LOCKSCREEN_FILE="$HOME/.config/lockscreen"
KEYWORD=""
DISPLAY_RES=$(xdpyinfo | grep dimensions | sed -r 's/^[^0-9]*([0-9]+x[0-9]+).*$/\1/')
WIDTHBY2=$(( $(echo "$DISPLAY_RES" | cut -d'x' -f1) / 2 ))
HEIGHTBY2=$(( $(echo "$DISPLAY_RES" | cut -d'x' -f2) / 2 ))

while getopts ":k:" o; do
    case "${o}" in
        k)
            KEYWORD="${OPTARG}"
            ;;
        *)
            echo "Wrong usage"
            ;;
    esac
done
shift $((OPTIND-1))

if [ -f "$1" ]; then
    BASE_NAME=$( basename "$1" )
    SELECTED_WALL="${1}"
fi

if [ -d "$1" ]; then
    WALLPAPER_DIR="$1"
    RANDOM_WALL=$( find "$WALLPAPER_DIR" -name "*.jpg" -o -name "*.png" -type f | grep -i "$KEYWORD" | shuf -n 1 )
    BASE_NAME=$( basename "$RANDOM_WALL" )
    SELECTED_WALL="${RANDOM_WALL}"
fi

convert "${SELECTED_WALL}" -geometry "${DISPLAY_RES}^" -gravity center -crop "${DISPLAY_RES}+0+0" "${WALLPAPER_FILE}"
convert "${WALLPAPER_FILE}" -filter Gaussian -blur 0x3 -gravity center -fill "$BGCOL" -draw "circle ${WIDTHBY2},${HEIGHTBY2} $(( WIDTHBY2 + 150 )),${HEIGHTBY2}" "${LOCKSCREEN_FILE}" &
# display -size "${DISPLAY_RES}" -window root "${WALLPAPER_FILE}"
xwallpaper --zoom "${WALLPAPER_FILE}"
notify-send -t 3000 "Wallpaper set to $BASE_NAME"
